# ===============================================
# GitHub Actions CI/CD 配置
# ===============================================
#
# 这是什么？
# - GitHub Actions 是 GitHub 提供的 CI/CD 服务
# - 当你 push 代码时，会自动执行这个工作流
# - 可以自动构建、测试、部署
#
# 触发条件：推送到 main 分支
# 执行内容：SSH 到服务器执行部署脚本
# ===============================================

name: Deploy to Production

# 触发条件
on:
  push:
    branches:
      - main
  # 也可以手动触发
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # 步骤 1: 检出代码
      - name: Checkout code
        uses: actions/checkout@v4

      # 步骤 2: 通过 SSH 部署到服务器
      - name: Deploy to server
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.SERVER_HOST }} # 服务器 IP
          username: ${{ secrets.SERVER_USER }} # SSH 用户名
          key: ${{ secrets.SERVER_SSH_KEY }} # SSH 私钥
          script: |
            cd /opt/starthere
            git pull origin main
            docker-compose down
            docker-compose up -d --build
            docker image prune -f

# ===============================================
# 配置说明
# ===============================================
#
# 需要在 GitHub 仓库设置 Secrets：
# 1. 进入仓库 → Settings → Secrets and variables → Actions
# 2. 添加以下 secrets：
#    - SERVER_HOST: 你的服务器公网 IP
#    - SERVER_USER: SSH 登录用户名（通常是 root）
#    - SERVER_SSH_KEY: SSH 私钥内容
#
# 如何生成 SSH 密钥对：
#   ssh-keygen -t ed25519 -C "github-actions"
#   # 私钥内容放到 SERVER_SSH_KEY
#   # 公钥添加到服务器的 ~/.ssh/authorized_keys
# ===============================================
