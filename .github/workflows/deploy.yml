# ===============================================
# GitHub Actions è‡ªåŠ¨éƒ¨ç½²å·¥ä½œæµ
# ===============================================
#
# å·¥ä½œæµç¨‹ï¼š
# 1. ä»£ç æ¨é€åˆ° main åˆ†æ”¯è§¦å‘
# 2. æ„å»º Docker é•œåƒï¼ˆè·¨å¹³å° linux/amd64ï¼‰
# 3. æ¨é€é•œåƒåˆ° GitHub Container Registry (ghcr.io)
# 4. SSH åˆ°æœåŠ¡å™¨ï¼Œæ‹‰å–æ–°é•œåƒå¹¶é‡å¯å®¹å™¨
#
# éœ€è¦é…ç½®çš„ GitHub Secretsï¼š
# - DEPLOY_HOST: æœåŠ¡å™¨ IP (115.191.33.64)
# - DEPLOY_USER: SSH ç”¨æˆ·å (root)
# - DEPLOY_KEY: SSH ç§é’¥ï¼ˆç”¨äºå…å¯†ç™»å½•ï¼‰
# ===============================================

name: Deploy to Production

# è§¦å‘æ¡ä»¶ï¼šæ¨é€åˆ° main åˆ†æ”¯
on:
  push:
    branches:
      - main
  # å¯é€‰ï¼šæ‰‹åŠ¨è§¦å‘
  workflow_dispatch:

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}/web

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    # éœ€è¦å†™æƒé™ä»¥æ¨é€é•œåƒåˆ° ghcr.io
    permissions:
      contents: read
      packages: write

    steps:
      # ========== 1. æ£€å‡ºä»£ç  ==========
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      # ========== 2. è®¾ç½® Docker Buildxï¼ˆæ”¯æŒè·¨å¹³å°æ„å»ºï¼‰==========
      - name: è®¾ç½® Docker Buildx
        uses: docker/setup-buildx-action@v3

      # ========== 3. ç™»å½•åˆ° GitHub Container Registry ==========
      - name: ç™»å½•åˆ° GHCR
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      # ========== 4. æå–é•œåƒå…ƒæ•°æ®ï¼ˆæ ‡ç­¾ã€æ³¨è§£ï¼‰==========
      - name: æå– Docker å…ƒæ•°æ®
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
          tags: |
            type=sha,prefix={{branch}}-
            type=raw,value=latest,enable={{is_default_branch}}

      # ========== 5. æ„å»ºå¹¶æ¨é€ Docker é•œåƒ ==========
      - name: æ„å»ºå¹¶æ¨é€é•œåƒ
        uses: docker/build-push-action@v5
        with:
          context: ./web
          file: ./web/Dockerfile
          platforms: linux/amd64 # æ˜ç¡®æŒ‡å®š x86 æ¶æ„ï¼ˆæœåŠ¡å™¨æ¶æ„ï¼‰
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      # ========== 6. éƒ¨ç½²åˆ°æœåŠ¡å™¨ ==========
      - name: éƒ¨ç½²åˆ°ç”Ÿäº§æœåŠ¡å™¨
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.DEPLOY_HOST }}
          username: ${{ secrets.DEPLOY_USER }}
          key: ${{ secrets.DEPLOY_KEY }}
          script: |
            # ç™»å½•åˆ° GitHub Container Registry
            echo "${{ secrets.GITHUB_TOKEN }}" | docker login ghcr.io -u ${{ github.actor }} --password-stdin

            # æ‹‰å–æœ€æ–°é•œåƒ
            docker pull ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest

            # åœæ­¢å¹¶åˆ é™¤æ—§å®¹å™¨
            docker stop starthere-web || true
            docker rm starthere-web || true

            # å¯åŠ¨æ–°å®¹å™¨
            docker run -d \
              --name starthere-web \
              --restart unless-stopped \
              -p 80:80 \
              ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest

            # æ¸…ç†æ‚¬ç©ºé•œåƒ
            docker image prune -f

            # éªŒè¯å®¹å™¨è¿è¡ŒçŠ¶æ€
            docker ps | grep starthere-web

      # ========== 7. é€šçŸ¥éƒ¨ç½²ç»“æœ ==========
      - name: éƒ¨ç½²æˆåŠŸé€šçŸ¥
        if: success()
        run: |
          echo "âœ… éƒ¨ç½²æˆåŠŸï¼"
          echo "ğŸŒ è®¿é—®åœ°å€: https://star-there.com"

# ===============================================
# é…ç½®è¯´æ˜
# ===============================================
#
# éœ€è¦åœ¨ GitHub ä»“åº“è®¾ç½® Secretsï¼š
# 1. è¿›å…¥ä»“åº“ â†’ Settings â†’ Secrets and variables â†’ Actions
# 2. æ·»åŠ ä»¥ä¸‹ secretsï¼š
#    - DEPLOY_HOST: æœåŠ¡å™¨ IP (115.191.33.64)
#    - DEPLOY_USER: SSH ç”¨æˆ·å (root)
#    - DEPLOY_KEY: SSH ç§é’¥å†…å®¹ï¼ˆå®Œæ•´å†…å®¹ï¼ŒåŒ…å« BEGIN/ENDï¼‰
#
# å¦‚ä½•ç”Ÿæˆå¹¶é…ç½® SSH å¯†é’¥å¯¹ï¼ˆå¦‚æœè¿˜æ²¡æœ‰ï¼‰ï¼š
#   # 1. æœ¬åœ°ç”Ÿæˆå¯†é’¥å¯¹
#   ssh-keygen -t ed25519 -C "github-actions" -f ~/.ssh/github_actions_key
#
#   # 2. å°†å…¬é’¥æ·»åŠ åˆ°æœåŠ¡å™¨
#   ssh-copy-id -i ~/.ssh/github_actions_key.pub root@115.191.33.64
#   # æˆ–æ‰‹åŠ¨: cat ~/.ssh/github_actions_key.pub >> ~/.ssh/authorized_keys
#
#   # 3. å°†ç§é’¥å†…å®¹å¤åˆ¶åˆ° GitHub Secrets
#   cat ~/.ssh/github_actions_key  # å…¨éƒ¨å†…å®¹å¤åˆ¶åˆ° DEPLOY_KEY
#
# æ³¨æ„äº‹é¡¹ï¼š
# - GITHUB_TOKEN æ˜¯è‡ªåŠ¨æä¾›çš„ï¼Œæ— éœ€æ‰‹åŠ¨é…ç½®
# - é•œåƒä¼šè‡ªåŠ¨æ¨é€åˆ° ghcr.io/ä½ çš„ç”¨æˆ·å/starthere/web
# - é¦–æ¬¡éœ€å°†é•œåƒæƒé™è®¾ä¸º publicï¼ˆghcr.io åŒ…è®¾ç½®ï¼‰
# ===============================================
