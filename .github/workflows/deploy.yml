# ===============================================
# GitHub Actions è‡ªåŠ¨éƒ¨ç½²å·¥ä½œæµ
# ===============================================
#
# å·¥ä½œæµç¨‹ï¼š
# 1. ä»£ç æ¨é€åˆ° main åˆ†æ”¯è§¦å‘
# 2. æ„å»º Docker é•œåƒï¼ˆè·¨å¹³å° linux/amd64ï¼‰
# 3. æ¨é€é•œåƒåˆ° GitHub Container Registry (ghcr.io)
# 4. SSH åˆ°æœåŠ¡å™¨ï¼Œæ‹‰å–æ–°é•œåƒå¹¶é‡å¯å®¹å™¨
#
# éœ€è¦é…ç½®çš„ GitHub Secretsï¼š
# - DEPLOY_HOST: æœåŠ¡å™¨ IP (115.191.33.64)
# - DEPLOY_USER: SSH ç”¨æˆ·å (root)
# - DEPLOY_KEY: SSH ç§é’¥ï¼ˆç”¨äºå…å¯†ç™»å½•ï¼‰
# ===============================================

name: Deploy to Production

# è§¦å‘æ¡ä»¶ï¼šæ¨é€åˆ° main åˆ†æ”¯
on:
  push:
    branches:
      - main
  # å¯é€‰ï¼šæ‰‹åŠ¨è§¦å‘
  workflow_dispatch:

env:
  REGISTRY: ghcr.io
  # IMAGE_NAME å°†åœ¨è¿è¡Œæ—¶ç”± GITHUB_REPOSITORY è½¬å°å†™ç”Ÿæˆ

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    # éœ€è¦å†™æƒé™ä»¥æ¨é€é•œåƒåˆ° ghcr.io
    permissions:
      contents: read
      packages: write

    steps:
      # ========== 1. æ£€å‡ºä»£ç  ==========
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      # ========== 1.1 ç”Ÿæˆå°å†™é•œåƒå ==========
      - name: ç”Ÿæˆå°å†™é•œåƒå
        run: |
          echo "IMAGE_WEB=${GITHUB_REPOSITORY,,}/web" >> $GITHUB_ENV
          echo "IMAGE_SERVER=${GITHUB_REPOSITORY,,}/server" >> $GITHUB_ENV

      # ========== 2. è®¾ç½® Docker Buildxï¼ˆæ”¯æŒè·¨å¹³å°æ„å»ºï¼‰==========
      - name: è®¾ç½® Docker Buildx
        uses: docker/setup-buildx-action@v3

      # ========== 3. ç™»å½•åˆ° GitHub Container Registry ==========
      - name: ç™»å½•åˆ° GHCR
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      # ========== 4. æå–å‰ç«¯é•œåƒå…ƒæ•°æ® ==========
      - name: æå–å‰ç«¯ Docker å…ƒæ•°æ®
        id: meta-web
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_WEB }}
          tags: |
            type=sha,prefix={{branch}}-
            type=raw,value=latest,enable={{is_default_branch}}

      # ========== 5. åç«¯é•œåƒå…ƒæ•°æ® ==========
      - name: æå–åç«¯ Docker å…ƒæ•°æ®
        id: meta-server
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_SERVER }}
          tags: |
            type=sha,prefix={{branch}}-
            type=raw,value=latest,enable={{is_default_branch}}

      # ========== 6. æ„å»ºå¹¶æ¨é€å‰ç«¯ Docker é•œåƒ ==========
      - name: æ„å»ºå¹¶æ¨é€å‰ç«¯é•œåƒ
        uses: docker/build-push-action@v5
        with:
          context: ./web
          file: ./web/Dockerfile
          platforms: linux/amd64
          push: true
          tags: ${{ steps.meta-web.outputs.tags }}
          labels: ${{ steps.meta-web.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      # ========== 7. æ„å»ºå¹¶æ¨é€åç«¯ Docker é•œåƒ ==========
      - name: æ„å»ºå¹¶æ¨é€åç«¯é•œåƒ
        uses: docker/build-push-action@v5
        with:
          context: ./server
          file: ./server/Dockerfile
          platforms: linux/amd64
          push: true
          tags: ${{ steps.meta-server.outputs.tags }}
          labels: ${{ steps.meta-server.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      # ========== 8. éƒ¨ç½²åˆ°æœåŠ¡å™¨ ==========
      - name: éƒ¨ç½²åˆ°ç”Ÿäº§æœåŠ¡å™¨
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.DEPLOY_HOST }}
          username: ${{ secrets.DEPLOY_USER }}
          key: ${{ secrets.DEPLOY_KEY }}
          script: |
            # ç™»å½•åˆ° GitHub Container Registry
            echo "${{ secrets.GITHUB_TOKEN }}" | docker login ghcr.io -u ${{ github.actor }} --password-stdin

            # ========== éƒ¨ç½²å‰ç«¯ ==========
            echo; echo "=== éƒ¨ç½²å‰ç«¯..."
            docker pull ${{ env.REGISTRY }}/${{ env.IMAGE_WEB }}:latest
            docker stop starthere-web || true
            docker rm starthere-web || true
            docker run -d \
              --name starthere-web \
              --restart unless-stopped \
              -p 80:80 \
              ${{ env.REGISTRY }}/${{ env.IMAGE_WEB }}:latest
            echo "âœ… å‰ç«¯éƒ¨ç½²å®Œæˆ"

            # ========== éƒ¨ç½²åç«¯ ==========
            echo; echo "=== éƒ¨ç½²åç«¯..."
            docker pull ${{ env.REGISTRY }}/${{ env.IMAGE_SERVER }}:latest
            docker stop starthere-server || true
            docker rm starthere-server || true
            docker run -d \
              --name starthere-server \
              --restart unless-stopped \
              -p 8080:8080 \
              -e SERVER_PORT=8080 \
              -e GIN_MODE=release \
              -e DB_HOST=${{ secrets.DB_HOST }} \
              -e DB_PORT=${{ secrets.DB_PORT }} \
              -e DB_USER=${{ secrets.DB_USER }} \
              -e DB_PASSWORD=${{ secrets.DB_PASSWORD }} \
              -e DB_NAME=${{ secrets.DB_NAME }} \
              -e JWT_SECRET=${{ secrets.JWT_SECRET }} \
              -e JWT_EXPIRY_HOURS=24 \
              ${{ env.REGISTRY }}/${{ env.IMAGE_SERVER }}:latest
            echo "âœ… åç«¯éƒ¨ç½²å®Œæˆ"

            # ========== æ¸…ç† ==========
            echo; echo "æ¸…ç†..."
            docker image prune -f
            docker logout ghcr.io

            # ========== éªŒè¯ ==========
            echo; echo "è¿è¡Œä¸­çš„å®¹å™¨ï¼š"
            docker ps | grep starthere

      # ========== 9. é€šçŸ¥éƒ¨ç½²ç»“æœ ==========
      - name: éƒ¨ç½²æˆåŠŸé€šçŸ¥
        if: success()
        run: |
          echo "âœ… éƒ¨ç½²æˆåŠŸï¼"
          echo "ğŸŒ å‰ç«¯: https://star-there.com"
          echo "ğŸ”§ åç«¯: http://${{ secrets.DEPLOY_HOST }}:8080"

# ===============================================
# é…ç½®è¯´æ˜
# ===============================================
#
# éœ€è¦åœ¨ GitHub ä»“åº“è®¾ç½® Secretsï¼š
# 1. è¿›å…¥ä»“åº“ â†’ Settings â†’ Secrets and variables â†’ Actions
# 2. æ·»åŠ ä»¥ä¸‹ secretsï¼š
#    - DEPLOY_HOST: æœåŠ¡å™¨ IP (115.191.33.64)
#    - DEPLOY_USER: SSH ç”¨æˆ·å (root)
#    - DEPLOY_KEY: SSH ç§é’¥å†…å®¹ï¼ˆå®Œæ•´å†…å®¹ï¼ŒåŒ…å« BEGIN/ENDï¼‰
#    - DB_HOST: æ•°æ®åº“ä¸»æœºåœ°å€
#    - DB_PORT: æ•°æ®åº“ç«¯å£ (3306)
#    - DB_USER: æ•°æ®åº“ç”¨æˆ·å
#    - DB_PASSWORD: æ•°æ®åº“å¯†ç 
#    - DB_NAME: æ•°æ®åº“åç§°
#    - JWT_SECRET: JWT å¯†é’¥ï¼ˆéšæœºå­—ç¬¦ä¸²ï¼‰
#
# å¦‚ä½•ç”Ÿæˆå¹¶é…ç½® SSH å¯†é’¥å¯¹ï¼ˆå¦‚æœè¿˜æ²¡æœ‰ï¼‰ï¼š
#   # 1. æœ¬åœ°ç”Ÿæˆå¯†é’¥å¯¹
#   ssh-keygen -t ed25519 -C "github-actions" -f ~/.ssh/github_actions_key
#
#   # 2. å°†å…¬é’¥æ·»åŠ åˆ°æœåŠ¡å™¨
#   ssh-copy-id -i ~/.ssh/github_actions_key.pub root@115.191.33.64
#   # æˆ–æ‰‹åŠ¨: cat ~/.ssh/github_actions_key.pub >> ~/.ssh/authorized_keys
#
#   # 3. å°†ç§é’¥å†…å®¹å¤åˆ¶åˆ° GitHub Secrets
#   cat ~/.ssh/github_actions_key  # å…¨éƒ¨å†…å®¹å¤åˆ¶åˆ° DEPLOY_KEY
#
# æ³¨æ„äº‹é¡¹ï¼š
# - GITHUB_TOKEN æ˜¯è‡ªåŠ¨æä¾›çš„ï¼Œæ— éœ€æ‰‹åŠ¨é…ç½®
# - é•œåƒä¼šè‡ªåŠ¨æ¨é€åˆ° ghcr.io/ä½ çš„ç”¨æˆ·å/starthere/web å’Œ /server
# - é¦–æ¬¡éœ€å°†é•œåƒæƒé™è®¾ä¸º publicï¼ˆghcr.io åŒ…è®¾ç½®ï¼‰
# ===============================================
