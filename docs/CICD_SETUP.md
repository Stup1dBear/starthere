# GitHub Actions CI/CD é…ç½®æŒ‡å—

> è‡ªåŠ¨åŒ–éƒ¨ç½²é…ç½®æ­¥éª¤ï¼ŒæŒ‰é¡ºåºæ‰§è¡Œå³å¯å®Œæˆé…ç½®

---

## ğŸ“‹ å‰ç½®æ¡ä»¶æ£€æŸ¥

- [x] æœåŠ¡å™¨ IP: `115.191.33.64`
- [x] æœåŠ¡å™¨å·²å®‰è£… Docker
- [x] æœåŠ¡å™¨é¡¹ç›®ç›®å½•: `/root/starthere`
- [ ] ç”Ÿæˆ SSH å¯†é’¥å¯¹ç”¨äº GitHub Actions
- [ ] é…ç½® GitHub Secrets

---

## ğŸ”‘ æ­¥éª¤ 1: ç”Ÿæˆ SSH å¯†é’¥å¯¹ï¼ˆå¦‚æœè¿˜æ²¡æœ‰ï¼‰

åœ¨æœ¬åœ° Mac ä¸Šæ‰§è¡Œï¼š

```bash
# ç”Ÿæˆä¸“ç”¨äº GitHub Actions çš„å¯†é’¥å¯¹
ssh-keygen -t ed25519 -C "github-actions" -f ~/.ssh/github_actions_key

# æŸ¥çœ‹å…¬é’¥å†…å®¹
cat ~/.ssh/github_actions_key.pub
```

å°†å…¬é’¥æ·»åŠ åˆ°æœåŠ¡å™¨ï¼ˆä¸¤ç§æ–¹å¼ä»»é€‰å…¶ä¸€ï¼‰ï¼š

**æ–¹å¼ Aï¼šä½¿ç”¨ ssh-copy-idï¼ˆæ¨èï¼‰**

```bash
ssh-copy-id -i ~/.ssh/github_actions_key.pub root@115.191.33.64
```

**æ–¹å¼ Bï¼šæ‰‹åŠ¨æ·»åŠ **

```bash
# 1. å¤åˆ¶å…¬é’¥å†…å®¹
cat ~/.ssh/github_actions_key.pub

# 2. SSH åˆ°æœåŠ¡å™¨
ssh root@115.191.33.64

# 3. è¿½åŠ åˆ° authorized_keys
echo "åˆšæ‰å¤åˆ¶çš„å…¬é’¥å†…å®¹" >> ~/.ssh/authorized_keys

# 4. è®¾ç½®æƒé™
chmod 600 ~/.ssh/authorized_keys
chmod 700 ~/.ssh
```

éªŒè¯å¯†é’¥æ˜¯å¦ç”Ÿæ•ˆï¼š

```bash
ssh -i ~/.ssh/github_actions_key root@115.191.33.64
# åº”è¯¥æ— éœ€å¯†ç å³å¯ç™»å½•
```

---

## ğŸ” æ­¥éª¤ 2: é…ç½® GitHub Secrets

1. æ‰“å¼€ä»“åº“é¡µé¢ï¼šhttps://github.com/Stup1dBear/starthere

2. è¿›å…¥ **Settings** â†’ **Secrets and variables** â†’ **Actions**

3. ç‚¹å‡» **New repository secret**ï¼Œæ·»åŠ ä»¥ä¸‹ 3 ä¸ª secretsï¼š

### Secret 1: DEPLOY_HOST

```
Name: DEPLOY_HOST
Value: 115.191.33.64
```

### Secret 2: DEPLOY_USER

```
Name: DEPLOY_USER
Value: root
```

### Secret 3: DEPLOY_KEY

```
Name: DEPLOY_KEY
Value: <SSH ç§é’¥å®Œæ•´å†…å®¹>
```

è·å–ç§é’¥å†…å®¹ï¼š

```bash
cat ~/.ssh/github_actions_key
```

å¤åˆ¶**å…¨éƒ¨å†…å®¹**ï¼ˆåŒ…æ‹¬ `-----BEGIN OPENSSH PRIVATE KEY-----` å’Œ `-----END OPENSSH PRIVATE KEY-----`ï¼‰ï¼Œç²˜è´´åˆ° Value ä¸­ã€‚

---

## ğŸ“¦ æ­¥éª¤ 3: é…ç½® GitHub å®¹å™¨é•œåƒæƒé™

æ¨é€çš„é•œåƒé»˜è®¤æ˜¯ç§æœ‰çš„ï¼Œéœ€è¦è®¾ç½®ä¸ºå…¬å¼€ï¼ˆæˆ–ä¿æŒç§æœ‰å¹¶é…ç½® pull secretï¼‰ã€‚

### æ–¹å¼ Aï¼šè®¾ä¸ºå…¬å¼€ï¼ˆæ¨èï¼Œç®€å•ï¼‰

1. é¦–æ¬¡æ¨é€åï¼Œè¿›å…¥ https://github.com/Stup1dBear?tab=packages
2. æ‰¾åˆ° `starthere/web` åŒ…
3. ç‚¹å‡» **Package settings**
4. æ»šåŠ¨åˆ°åº•éƒ¨ **Danger Zone**
5. ç‚¹å‡» **Change visibility** â†’ **Public**

### æ–¹å¼ Bï¼šä¿æŒç§æœ‰ï¼ˆéœ€é¢å¤–é…ç½®ï¼‰

æœåŠ¡å™¨éœ€ç™»å½• ghcr.io æ‰èƒ½æ‹‰å–ç§æœ‰é•œåƒï¼š

```bash
# åœ¨æœåŠ¡å™¨ä¸Šæ‰§è¡Œï¼ˆä½¿ç”¨ä½ çš„ GitHub Personal Access Tokenï¼‰
docker login ghcr.io -u Stup1dBear -p <YOUR_PAT>
```

---

## âœ… æ­¥éª¤ 4: éªŒè¯é…ç½®

### 4.1 æ£€æŸ¥ Secrets æ˜¯å¦å·²æ·»åŠ 

è¿›å…¥ä»“åº“ **Settings** â†’ **Secrets and variables** â†’ **Actions**ï¼Œåº”è¯¥çœ‹åˆ°ï¼š

- âœ… DEPLOY_HOST
- âœ… DEPLOY_USER
- âœ… DEPLOY_KEY

### 4.2 è§¦å‘é¦–æ¬¡éƒ¨ç½²

**æ–¹å¼ Aï¼šæ¨é€ä»£ç è§¦å‘**

```bash
# åœ¨æœ¬åœ°é¡¹ç›®ç›®å½•
cd /Users/zhengyi/projects/starthere

# æäº¤å¹¶æ¨é€ï¼ˆç¡®ä¿åœ¨ main åˆ†æ”¯ï¼‰
git add .
git commit -m "feat: é…ç½® CI/CD è‡ªåŠ¨éƒ¨ç½²"
git push origin main
```

**æ–¹å¼ Bï¼šæ‰‹åŠ¨è§¦å‘**

1. è¿›å…¥ä»“åº“ **Actions** é¡µé¢
2. é€‰æ‹© **Deploy to Production** å·¥ä½œæµ
3. ç‚¹å‡» **Run workflow** â†’ **Run workflow**

### 4.3 æŸ¥çœ‹éƒ¨ç½²æ—¥å¿—

1. è¿›å…¥ **Actions** é¡µé¢
2. ç‚¹å‡»æœ€æ–°çš„å·¥ä½œæµè¿è¡Œ
3. æŸ¥çœ‹æ¯ä¸ªæ­¥éª¤çš„æ—¥å¿—

æœŸæœ›çœ‹åˆ°ï¼š

- âœ… æ£€å‡ºä»£ç 
- âœ… æ„å»ºå¹¶æ¨é€é•œåƒ
- âœ… éƒ¨ç½²åˆ°ç”Ÿäº§æœåŠ¡å™¨
- âœ… éƒ¨ç½²æˆåŠŸé€šçŸ¥

### 4.4 éªŒè¯éƒ¨ç½²ç»“æœ

```bash
# SSH åˆ°æœåŠ¡å™¨
ssh root@115.191.33.64

# æ£€æŸ¥å®¹å™¨çŠ¶æ€
docker ps | grep starthere-web

# æ£€æŸ¥æ—¥å¿—
docker logs starthere-web

# æœ¬åœ°éªŒè¯è®¿é—®
curl https://star-there.com
```

---

## ğŸš€ åç»­ä½¿ç”¨

é…ç½®å®Œæˆåï¼Œæ¯æ¬¡æ¨é€ä»£ç åˆ° `main` åˆ†æ”¯éƒ½ä¼šè‡ªåŠ¨è§¦å‘éƒ¨ç½²ï¼š

```bash
# ä¿®æ”¹ä»£ç å
git add .
git commit -m "feat: æ–°åŠŸèƒ½"
git push origin main

# è‡ªåŠ¨è§¦å‘ï¼šæ„å»º â†’ æ¨é€é•œåƒ â†’ éƒ¨ç½²
# çº¦ 3-5 åˆ†é’Ÿåç”Ÿæ•ˆ
```

---

## ğŸ”§ å¸¸è§é—®é¢˜æ’æŸ¥

### Q1: éƒ¨ç½²å¤±è´¥ "Permission denied (publickey)"

**åŸå› **ï¼šSSH å¯†é’¥æœªæ­£ç¡®é…ç½®

**è§£å†³**ï¼š

```bash
# 1. ç¡®è®¤ç§é’¥å†…å®¹å®Œæ•´ï¼ˆåŒ…å« BEGIN/END è¡Œï¼‰
cat ~/.ssh/github_actions_key

# 2. é‡æ–°æ·»åŠ å…¬é’¥åˆ°æœåŠ¡å™¨
ssh-copy-id -i ~/.ssh/github_actions_key.pub root@115.191.33.64

# 3. æœ¬åœ°æµ‹è¯•è¿æ¥
ssh -i ~/.ssh/github_actions_key root@115.191.33.64
```

### Q2: é•œåƒæ‹‰å–å¤±è´¥ "unauthorized"

**åŸå› **ï¼šé•œåƒæƒé™æœªè®¾ç½®æˆ– token è¿‡æœŸ

**è§£å†³**ï¼š

- æ£€æŸ¥é•œåƒæ˜¯å¦è®¾ä¸ºå…¬å¼€ï¼ˆè§æ­¥éª¤ 3ï¼‰
- æˆ–åœ¨æœåŠ¡å™¨é‡æ–°ç™»å½• ghcr.io

### Q3: å®¹å™¨å¯åŠ¨å¤±è´¥

**åŸå› **ï¼šç«¯å£å ç”¨æˆ–é…ç½®é”™è¯¯

**è§£å†³**ï¼š

```bash
# SSH åˆ°æœåŠ¡å™¨
ssh root@115.191.33.64

# æŸ¥çœ‹å®¹å™¨æ—¥å¿—
docker logs starthere-web

# æ£€æŸ¥ç«¯å£å ç”¨
netstat -tlnp | grep :80
```

### Q4: æ„å»ºè¶…æ—¶æˆ–å¤±è´¥

**åŸå› **ï¼šä¾èµ–ä¸‹è½½æ…¢æˆ–æ„å»ºé”™è¯¯

**è§£å†³**ï¼š

- æŸ¥çœ‹ Actions æ—¥å¿—å®šä½å…·ä½“é”™è¯¯
- æœ¬åœ°å…ˆæµ‹è¯•æ„å»ºï¼š`cd web && docker build -t test .`

---

## ğŸ“– å·¥ä½œæµè¯´æ˜

### è§¦å‘æ¡ä»¶

- æ¨é€åˆ° `main` åˆ†æ”¯è‡ªåŠ¨è§¦å‘
- æ”¯æŒæ‰‹åŠ¨è§¦å‘ï¼ˆActions â†’ Run workflowï¼‰

### æ‰§è¡Œæµç¨‹

1. **æ„å»ºé˜¶æ®µ**ï¼ˆGitHub Actions Runnerï¼‰
   - æ£€å‡ºä»£ç 
   - è®¾ç½® Docker Buildx
   - æ„å»º linux/amd64 é•œåƒ
   - æ¨é€åˆ° ghcr.io

2. **éƒ¨ç½²é˜¶æ®µ**ï¼ˆæœåŠ¡å™¨ï¼‰
   - SSH è¿æ¥æœåŠ¡å™¨
   - æ‹‰å–æœ€æ–°é•œåƒ
   - åœæ­¢æ—§å®¹å™¨
   - å¯åŠ¨æ–°å®¹å™¨
   - æ¸…ç†æ—§é•œåƒ

### é•œåƒæ ‡ç­¾ç­–ç•¥

- `latest`: æœ€æ–°ç‰ˆæœ¬ï¼ˆmain åˆ†æ”¯ï¼‰
- `main-<commit-sha>`: å¸¦ commit SHA çš„ç‰ˆæœ¬ï¼ˆä¾¿äºå›æ»šï¼‰

---

## ğŸ¯ ä¸‹ä¸€æ­¥ä¼˜åŒ–æ–¹å‘

é…ç½®å®Œæˆåï¼Œå¯ä»¥è€ƒè™‘ï¼š

1. **æ·»åŠ å¥åº·æ£€æŸ¥**ï¼šéƒ¨ç½²åè‡ªåŠ¨éªŒè¯æœåŠ¡å¯ç”¨æ€§
2. **è“ç»¿éƒ¨ç½²**ï¼šé›¶åœæœºæ›´æ–°
3. **å›æ»šæœºåˆ¶**ï¼šå¿«é€Ÿå›é€€åˆ°ä¸Šä¸€ç‰ˆæœ¬
4. **å¤šç¯å¢ƒæ”¯æŒ**ï¼šåŒºåˆ† dev/staging/prod
5. **é€šçŸ¥é›†æˆ**ï¼šéƒ¨ç½²æˆåŠŸ/å¤±è´¥å‘é€é€šçŸ¥ï¼ˆé’‰é’‰/ä¼ä¸šå¾®ä¿¡/é‚®ä»¶ï¼‰

---

_æ›´æ–°æ—¶é—´ï¼š2026-01-28_
